# Example Specification Proposal
# Generated by Ignition phase after interview synthesis
# Presented to user for approval before proceeding to Lattice

[meta]
version = "v1"
generated_at = "2025-01-24T10:00:00Z"
project_id = "payment-processor"
interview_state_hash = "sha256:a1b2c3d4e5f6..."
architect_model = "claude-opus-4"
auditor_model = "kimi-k2"

# =============================================================================
# SUMMARY
# =============================================================================

[summary]
one_liner = "High-performance B2B payment processing system with fraud detection"

problem_statement = """
Current payment processing system is too slow and cannot scale to handle growing
B2B transaction volume. Need to scale from 5,000 to 50,000 transactions/day
within one year while maintaining sub-100ms latency and zero data inconsistency.
"""

[[summary.target_users]]
persona = "Internal Finance Team"
needs = "Manage accounts, review transactions, handle flagged fraud cases"

[[summary.target_users]]
persona = "Partner Companies"
needs = "Programmatic API access for initiating transfers between accounts"

[[summary.success_criteria]]
criterion = "Transaction latency"
metric = "p99 latency"
target = "< 100ms"

[[summary.success_criteria]]
criterion = "Data integrity"
metric = "Balance inconsistencies"
target = "Zero"

[[summary.success_criteria]]
criterion = "Availability"
metric = "Uptime"
target = "99.99%"

[summary.scope_boundaries]
in_scope = [
    "Account lifecycle management",
    "Fund transfers (deposit, withdraw, transfer)",
    "Fraud detection integration",
    "Multi-currency account support",
    "Partner API",
]
out_of_scope = [
    "Building fraud ML models (external service)",
    "Mobile applications",
    "End-user facing UI",
]
future_scope = [
    "Analytics dashboards",
    "Automated reconciliation",
    "Batch processing",
]

# =============================================================================
# FEATURES
# =============================================================================

[[features.core]]
id = "f001"
name = "Account Management"
description = "Create, view, freeze, and close business accounts"
user_stories = [
    "As a finance team member, I can create a new account for a business partner",
    "As a finance team member, I can view account details and balance",
    "As a finance team member, I can freeze an account pending investigation",
]
acceptance_criteria = [
    "Accounts have unique identifiers",
    "Account balance is always non-negative",
    "Account status transitions are enforced (Active → Frozen → Closed)",
]
complexity_estimate = "moderate"

[[features.core]]
id = "f002"
name = "Deposits"
description = "Deposit funds into accounts from external sources"
user_stories = [
    "As a partner company, I can deposit funds via API",
    "As a finance team member, I can record manual deposits",
]
acceptance_criteria = [
    "Deposits are atomic - either complete or don't happen",
    "All deposits create audit trail entries",
    "Deposits update balance in real-time",
]
complexity_estimate = "simple"

[[features.core]]
id = "f003"
name = "Transfers"
description = "Transfer funds between accounts within the system"
user_stories = [
    "As a partner company, I can transfer funds to another partner's account",
    "As a finance team member, I can execute transfers on behalf of partners",
]
acceptance_criteria = [
    "Transfers are atomic - source debited and destination credited together",
    "Insufficient balance prevents transfer (no overdraft)",
    "Transfers between different currencies use current exchange rates",
    "All transfers pass through fraud scoring before execution",
]
dependencies = ["f001", "f005", "f010"]
complexity_estimate = "complex"

[[features.core]]
id = "f004"
name = "Withdrawals"
description = "Withdraw funds to external bank accounts"
user_stories = [
    "As a partner company, I can withdraw funds to my registered bank account",
]
acceptance_criteria = [
    "Withdrawals require verified bank account linkage",
    "Withdrawal requests are queued for batch processing to bank gateway",
    "Failed withdrawals are automatically retried with exponential backoff",
]
complexity_estimate = "complex"

[[features.core]]
id = "f005"
name = "Fraud Detection"
description = "Integrate with external ML service to score and flag suspicious transactions"
user_stories = [
    "As the system, I score every transaction before execution",
    "As a finance team member, I can review flagged transactions",
    "As a finance team member, I can approve or reject flagged transactions",
]
acceptance_criteria = [
    "All transactions are scored before execution",
    "Transactions with score > 0.8 are held for manual review",
    "Flagged transactions timeout after 24 hours if not reviewed",
]
complexity_estimate = "moderate"

[[features.foundational]]
id = "f010"
name = "Multi-currency Support"
description = "Support multiple currencies in accounts and transfers"
rationale = "Affects account model, transfer logic, and API design. Must be architected from the start."
user_stories = [
    "As a partner company, I can hold balances in multiple currencies",
    "As a partner company, I can transfer between accounts of different currencies",
]
acceptance_criteria = [
    "Each account has a single currency (multiple accounts per business for multi-currency)",
    "Cross-currency transfers use real-time exchange rates",
    "Exchange rate source is configurable",
]
architectural_impact = "Currency becomes a core field on Account. Transfer logic must handle currency conversion. Exchange rate service becomes a required integration."
complexity_estimate = "complex"

[[features.bolt_on]]
id = "f020"
name = "Analytics Dashboards"
description = "Transaction analytics and reporting for finance team"
rationale = "Pure presentation layer over existing data. No impact on core transaction processing."
complexity_estimate = "moderate"

# =============================================================================
# ARCHITECTURE
# =============================================================================

[architecture]
language = "rust"
language_rationale = "Performance requirements (sub-100ms p99) and financial data integrity needs favor Rust's memory safety and zero-cost abstractions. Strong type system enables encoding business rules at compile time."
platform = "web_backend"
primary_patterns = ["hexagonal", "cqrs"]

[architecture.data_storage]
primary = "PostgreSQL"
rationale = "ACID compliance essential for financial transactions. Mature, battle-tested for high-value data."
alternatives_considered = [
    "CockroachDB - considered for horizontal scaling, rejected due to operational complexity",
    "SQLite - rejected due to concurrent write limitations",
]

[[architecture.external_integrations]]
name = "Bank Gateway"
purpose = "Execute withdrawals to external bank accounts"
protocol = "REST API with mTLS"
required = true

[[architecture.external_integrations]]
name = "Fraud Detection Service"
purpose = "ML-based transaction scoring"
protocol = "gRPC"
required = true

[[architecture.external_integrations]]
name = "Exchange Rate Service"
purpose = "Real-time currency conversion rates"
protocol = "REST API"
required = true

[[architecture.module_structure]]
name = "domain"
responsibility = "Core business logic, entities, and invariants"
dependencies = []

[[architecture.module_structure]]
name = "application"
responsibility = "Use cases, orchestration, transaction boundaries"
dependencies = ["domain"]

[[architecture.module_structure]]
name = "infrastructure"
responsibility = "Database, external service clients, API handlers"
dependencies = ["domain", "application"]

[[architecture.module_structure]]
name = "api"
responsibility = "REST API endpoints for partners and internal tools"
dependencies = ["application"]

# =============================================================================
# CONSTRAINTS
# =============================================================================

[[constraints.functional]]
id = "func_001"
description = "Account balance never goes negative"
source = "user_explicit"
testable = true
verification_method = "Property-based testing with arbitrary transaction sequences"

[[constraints.functional]]
id = "func_002"
description = "Completed transactions are immutable"
source = "best_practice"
testable = true
verification_method = "Attempt mutation after completion, verify rejection"

[[constraints.functional]]
id = "func_003"
description = "Transfer atomically decrements source and increments destination"
source = "user_explicit"
testable = true
verification_method = "Concurrent transfer testing, sum invariant verification"

[[constraints.performance]]
id = "perf_001"
description = "p99 transaction latency < 100ms"
source = "user_explicit"
testable = true
verification_method = "Load testing with production-like traffic patterns"

[[constraints.performance]]
id = "perf_002"
description = "System handles 50,000 transactions/day"
source = "user_explicit"
testable = true
verification_method = "Sustained load testing at 1.5x target volume"

[[constraints.security]]
id = "sec_001"
description = "All external API calls use mTLS"
source = "best_practice"
testable = true
verification_method = "Certificate validation in integration tests"

[[constraints.security]]
id = "sec_002"
description = "No PII in application logs"
source = "best_practice"
testable = true
verification_method = "Log scrubbing verification, PII pattern detection"

[[constraints.security]]
id = "sec_003"
description = "Partner API requires authentication"
source = "inferred"
testable = true
verification_method = "Unauthenticated request rejection tests"

# =============================================================================
# DESIGN DECISIONS
# =============================================================================

[[design_decisions]]
id = "dd_001"
area = "Error Handling"
decision = "Fail fast with structured error types, surface errors to callers immediately"
rationale = "Financial systems should not silently swallow errors. Explicit error handling prevents hidden inconsistencies."
delegated = true
user_notes_considered = "User did not specify, but mentioned zero tolerance for data inconsistency"

[[design_decisions]]
id = "dd_002"
area = "API Style"
decision = "REST API with OpenAPI specification"
rationale = "Partner companies expect REST. OpenAPI enables code generation for client SDKs."
delegated = true
alternatives_considered = [
    { option = "GraphQL", rejected_because = "Overkill for this domain, adds complexity" },
    { option = "gRPC", rejected_because = "Partner adoption barrier, REST more universal" },
]

[[design_decisions]]
id = "dd_003"
area = "Concurrency Model"
decision = "Optimistic locking with version fields on Account"
rationale = "Prevents lost updates on concurrent transfers without pessimistic lock contention"
delegated = false

# =============================================================================
# OPEN QUESTIONS
# =============================================================================

[[open_questions]]
id = "q1"
question = "Should failed transactions retry automatically or require manual intervention?"
context = "Affects error handling strategy and user workflow for the finance team"
architect_recommendation = "Automatic retry with exponential backoff for transient failures (network, timeout). Manual intervention for business rule failures (insufficient funds, fraud flag)."
blocking = false

[[open_questions]]
id = "q2"
question = "What is the exchange rate update frequency requirement?"
context = "Affects whether we cache rates or fetch real-time for every cross-currency transfer"
architect_recommendation = "Cache with 5-minute TTL for most transfers. Option for real-time fetch on high-value transfers (> $10,000)."
blocking = false

# =============================================================================
# RISKS
# =============================================================================

[[risks]]
id = "risk_001"
description = "External fraud service latency may impact transaction throughput"
severity = "medium"
mitigation = "Implement circuit breaker. Allow configurable bypass for low-risk transactions during service degradation."

[[risks]]
id = "risk_002"
description = "Exchange rate service unavailability blocks cross-currency transfers"
severity = "high"
mitigation = "Cache last known rates with staleness indicator. Alert on stale rates. Consider secondary rate provider."

# =============================================================================
# AUDITOR NOTES
# =============================================================================

[[auditor_notes]]
concern = "The 99.99% uptime target conflicts with the single PostgreSQL database architecture"
architect_response = "Will use PostgreSQL with streaming replication and automatic failover. Architecture supports this, detailed HA design in Lattice phase."
resolved = true

[[auditor_notes]]
concern = "Fraud service integration as synchronous call may create latency bottleneck"
architect_response = "Valid concern. Will implement async scoring with short timeout. Transactions proceed with manual review flag if scoring times out."
resolved = true
