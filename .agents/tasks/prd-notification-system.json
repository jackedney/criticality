{
  "version": 2,
  "project": "Criticality Protocol Notification System (Phase 4.2)",
  "overview": "Implement a unified notification system that replaces the existing hook-based approach with webhook integration and configurable reminder scheduling. The system sends minimal notifications per decision block_005 and supports cron-like reminder schedules for blocking states.",
  "goals": [
    "Create a unified notification trait that replaces existing hook system",
    "Implement webhook integration with rich JSON payloads matching BlockingRecord structure",
    "Add configurable reminder scheduling using cron-like expressions",
    "Support multiple simultaneous notification channels",
    "Ensure minimal notification format per decision block_005",
    "Update ROADMAP.md to defer Slack integration to future phase",
    "Add decision to DECISIONS.toml documenting webhook-first approach"
  ],
  "nonGoals": [
    "Slack integration (deferred to future phase)",
    "Email integration (deferred to future phase)",
    "Interactive notifications (webhook is one-way)",
    "Web dashboard notifications (Phase 4.3)"
  ],
  "successMetrics": [
    "Webhook notifications sent successfully on blocking, complete, error, and phase_change events",
    "Reminder system triggers at configured cron intervals while blocked",
    "Multiple webhook endpoints can be configured simultaneously",
    "All quality gates pass: test, lint, typecheck, build"
  ],
  "openQuestions": [],
  "stack": {
    "framework": "TypeScript with Node.js",
    "hosting": "Local CLI (npm package)",
    "database": "File-based state persistence (existing)",
    "auth": "N/A - webhook endpoints configured by user"
  },
  "routes": [],
  "uiNotes": [
    "CLI displays notification status in status command output",
    "Webhook failures logged but do not block protocol execution",
    "Reminder schedule displayed in status when blocked"
  ],
  "dataModel": [
    {
      "entity": "NotificationChannel",
      "fields": [
        "type",
        "endpoint",
        "enabled",
        "events"
      ]
    },
    {
      "entity": "WebhookPayload",
      "fields": [
        "event",
        "timestamp",
        "blocking_record",
        "protocol_state"
      ]
    },
    {
      "entity": "ReminderSchedule",
      "fields": [
        "cron_expression",
        "enabled",
        "last_sent",
        "next_scheduled"
      ]
    },
    {
      "entity": "NotificationState",
      "fields": [
        "channels",
        "reminder_schedule",
        "sent_notifications"
      ]
    }
  ],
  "importFormat": {
    "description": "Configuration in criticality.toml",
    "example": {
      "notifications": {
        "enabled": true,
        "channels": [
          {
            "type": "webhook",
            "endpoint": "https://example.com/webhook",
            "enabled": true,
            "events": [
              "on_block",
              "on_complete",
              "on_error"
            ]
          }
        ],
        "reminder_schedule": "0 9 * * *"
      }
    }
  },
  "rules": [
    "Notifications are always minimal: 'Criticality blocked. Run `criticality status` for details.'",
    "Webhook payloads include full BlockingRecord structure for programmatic consumption",
    "Reminder schedule uses cron syntax (minute hour day month weekday)",
    "Multiple channels can be active simultaneously",
    "Notification failures are logged but never block protocol execution",
    "Reminders only sent while protocol is in blocked state"
  ],
  "qualityGates": [
    "npm run test",
    "npm run lint",
    "npm run typecheck",
    "npm run build"
  ],
  "stories": [
    {
      "id": "US-001",
      "title": "Update ROADMAP.md to defer Slack/email integration",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the roadmap updated to reflect that Slack and email integrations are deferred to a future phase, so that the documentation accurately reflects project scope.",
      "acceptanceCriteria": [
        "Update Phase 4.2 in ROADMAP.md to show Slack integration as deferred",
        "Update Phase 4.2 in ROADMAP.md to show email integration as deferred",
        "Add webhook integration as the primary notification channel for Phase 4.2",
        "Mark existing notification hooks items as complete (hooks are being replaced)",
        "Example: Phase 4.2 shows '- [x] Implement webhook integration' and '- [ ] Add Slack integration (deferred)'",
        "Negative case: Do not remove Slack/email from roadmap entirely, mark as future work"
      ],
      "startedAt": "2026-02-07T23:30:08.205153+00:00",
      "completedAt": "2026-02-07T23:32:52.050772+00:00",
      "updatedAt": "2026-02-07T23:32:52.050584+00:00"
    },
    {
      "id": "US-002",
      "title": "Add decision for webhook-first notification approach",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want a decision recorded in DECISIONS.toml explaining the webhook-first approach for notifications, so that future maintainers understand the rationale.",
      "acceptanceCriteria": [
        "Add new decision to DECISIONS.toml with ID following pattern (e.g., notify_001)",
        "Include rationale: webhooks provide maximum flexibility for integration",
        "Document that Slack/email are deferred to reduce scope and complexity",
        "Reference decision block_005 for minimal notification format",
        "Example: decision explains webhook allows users to integrate with any system",
        "Negative case: Do not contradict existing decisions about notification format"
      ],
      "startedAt": "2026-02-07T23:32:54.126604+00:00",
      "completedAt": "2026-02-07T23:35:18.950444+00:00",
      "updatedAt": "2026-02-07T23:35:18.950302+00:00"
    },
    {
      "id": "US-003",
      "title": "Define notification trait interface",
      "status": "done",
      "dependsOn": [
        "US-002"
      ],
      "description": "As a developer, I want a NotificationService interface that defines the contract for sending notifications, so that different channel implementations can be swapped.",
      "acceptanceCriteria": [
        "Create src/notifications/types.ts with NotificationService interface",
        "Define NotificationEvent enum: 'block', 'complete', 'error', 'phase_change'",
        "Define NotificationChannel interface with type, endpoint, enabled, events fields",
        "Define WebhookPayload interface matching BlockingRecord structure",
        "Define ReminderSchedule interface with cron_expression field",
        "Export all types from src/notifications/index.ts",
        "Example: NotificationService has send(event, payload) method",
        "Negative case: Interface does not include Slack or email specific methods"
      ],
      "startedAt": "2026-02-07T23:35:21.025509+00:00",
      "completedAt": "2026-02-07T23:38:39.056304+00:00",
      "updatedAt": "2026-02-07T23:38:39.056179+00:00"
    },
    {
      "id": "US-004",
      "title": "Implement cron expression parser",
      "status": "done",
      "dependsOn": [
        "US-003"
      ],
      "description": "As a developer, I want a cron expression parser so that reminder schedules can be configured flexibly.",
      "acceptanceCriteria": [
        "Create src/notifications/cron.ts with parseCronExpression function",
        "Support standard 5-field cron format: minute hour day month weekday",
        "Implement getNextOccurrence(cronExpr, fromDate) returning next trigger time",
        "Implement isValidCronExpression(expr) for config validation",
        "Support common patterns: '0 9 * * *' (daily at 9am), '0 */4 * * *' (every 4 hours)",
        "Add unit tests in src/notifications/cron.test.ts",
        "Example: '0 9 * * 1-5' returns next weekday at 9am",
        "Negative case: Invalid expression '99 99 * * *' returns validation error"
      ],
      "startedAt": "2026-02-07T23:38:41.152471+00:00",
      "completedAt": "2026-02-07T23:51:43.401716+00:00",
      "updatedAt": "2026-02-07T23:51:43.401580+00:00"
    },
    {
      "id": "US-005",
      "title": "Implement webhook notification sender",
      "status": "done",
      "dependsOn": [
        "US-003"
      ],
      "description": "As a developer, I want a webhook sender that posts notifications to configured endpoints, so that external systems can be notified of protocol events.",
      "acceptanceCriteria": [
        "Create src/notifications/webhook.ts with WebhookSender class",
        "Implement send(endpoint, payload) using fetch or node-fetch",
        "Include Content-Type: application/json header",
        "Set configurable timeout (default 5 seconds)",
        "Return success/failure result without throwing on HTTP errors",
        "Log failures but do not retry (fire-and-forget)",
        "Add unit tests with mocked fetch in src/notifications/webhook.test.ts",
        "Example: POST to endpoint with BlockingRecord as JSON body returns success",
        "Negative case: Network timeout returns failure result with error message"
      ],
      "startedAt": "2026-02-07T23:51:45.474160+00:00",
      "completedAt": "2026-02-08T00:03:53.864983+00:00",
      "updatedAt": "2026-02-08T00:03:53.864857+00:00"
    },
    {
      "id": "US-006",
      "title": "Create notification configuration schema",
      "status": "done",
      "dependsOn": [
        "US-003",
        "US-004"
      ],
      "description": "As a user, I want to configure notifications in criticality.toml so that I can specify webhook endpoints and reminder schedules.",
      "acceptanceCriteria": [
        "Extend src/config/types.ts NotificationConfig to support channels array",
        "Add channels field: array of NotificationChannel objects",
        "Add reminder_schedule field: string with cron expression",
        "Update src/config/parser.ts to parse new notification structure",
        "Update src/config/defaults.ts with sensible defaults (notifications disabled)",
        "Validate cron expression at config load time using isValidCronExpression",
        "Validate webhook URLs are valid URLs",
        "Add tests in src/config/parser.test.ts for new notification config",
        "Example: Config with two webhook endpoints and '0 9 * * *' schedule parses correctly",
        "Negative case: Invalid cron expression shows clear validation error"
      ],
      "startedAt": "2026-02-08T00:03:55.929026+00:00",
      "completedAt": "2026-02-08T00:19:24.231423+00:00",
      "updatedAt": "2026-02-08T00:19:24.231261+00:00"
    },
    {
      "id": "US-007",
      "title": "Implement unified NotificationService",
      "status": "done",
      "dependsOn": [
        "US-005",
        "US-006"
      ],
      "description": "As a developer, I want a NotificationService that manages all configured channels and sends notifications to each, so that notification logic is centralized.",
      "acceptanceCriteria": [
        "Create src/notifications/service.ts with NotificationService class",
        "Constructor takes NotificationConfig from parsed criticality.toml",
        "Implement notify(event, data) that sends to all enabled channels for that event",
        "Filter channels by their configured events array",
        "Build minimal message: 'Criticality blocked. Run `criticality status` for details.'",
        "Build rich payload with full BlockingRecord for webhook body",
        "Return aggregate result (which channels succeeded/failed)",
        "Add unit tests in src/notifications/service.test.ts",
        "Example: notify('block', record) sends to two configured webhooks",
        "Negative case: All channels fail returns aggregate failure but doesn't throw"
      ],
      "startedAt": "2026-02-08T00:19:26.304653+00:00",
      "completedAt": "2026-02-08T00:27:40.146873+00:00",
      "updatedAt": "2026-02-08T00:27:40.146739+00:00"
    },
    {
      "id": "US-008",
      "title": "Implement reminder scheduler",
      "status": "done",
      "dependsOn": [
        "US-004",
        "US-007"
      ],
      "description": "As a user, I want reminders sent on a cron schedule while the protocol is blocked, so that I don't forget about pending queries.",
      "acceptanceCriteria": [
        "Create src/notifications/reminder.ts with ReminderScheduler class",
        "Track last_sent and next_scheduled in notification state",
        "Implement checkAndSendReminder(currentTime, blockingRecord) method",
        "Only send reminder if: blocked AND current time >= next_scheduled",
        "Update next_scheduled after sending based on cron expression",
        "Persist reminder state to .criticality/notification-state.json",
        "Add unit tests in src/notifications/reminder.test.ts",
        "Example: Blocked at 8am, cron '0 9 * * *', reminder sent at 9am",
        "Negative case: Not blocked, no reminder sent even if schedule matches"
      ],
      "startedAt": "2026-02-08T00:27:42.212385+00:00",
      "completedAt": "2026-02-08T00:39:05.630609+00:00",
      "updatedAt": "2026-02-08T00:39:05.630456+00:00"
    },
    {
      "id": "US-009",
      "title": "Integrate NotificationService with orchestrator",
      "status": "done",
      "dependsOn": [
        "US-007"
      ],
      "description": "As a developer, I want the orchestrator to use NotificationService for all notifications, replacing the old hook system.",
      "acceptanceCriteria": [
        "Update src/protocol/orchestrator.ts to accept NotificationService",
        "Call notify('block', record) when entering blocked state",
        "Call notify('complete', summary) when protocol completes",
        "Call notify('error', error) when unrecoverable error occurs",
        "Call notify('phase_change', {from, to}) on phase transitions",
        "Remove references to old NotificationHooksExecutor from orchestrator",
        "Add integration test verifying notification calls",
        "Example: enterBlocking triggers notify('block', ...) call",
        "Negative case: Notification failure doesn't block protocol execution"
      ],
      "startedAt": "2026-02-08T00:39:07.698471+00:00",
      "completedAt": "2026-02-08T00:55:49.780263+00:00",
      "updatedAt": "2026-02-08T00:55:49.780125+00:00"
    },
    {
      "id": "US-010",
      "title": "Integrate NotificationService with CLI operations",
      "status": "done",
      "dependsOn": [
        "US-007",
        "US-009"
      ],
      "description": "As a developer, I want CLI operations to use the new NotificationService, removing the old hook-based approach.",
      "acceptanceCriteria": [
        "Update src/cli/operations.ts to use NotificationService",
        "Remove usage of NotificationHooksExecutor from CliOperations",
        "Update sendBlockingNotification to delegate to NotificationService",
        "Create NotificationService instance from parsed config",
        "Update tests in src/cli/operations.test.ts if they exist",
        "Example: CliOperations.sendBlockingNotification uses NotificationService.notify",
        "Negative case: Missing notification config uses disabled defaults"
      ],
      "startedAt": "2026-02-08T00:55:51.854179+00:00",
      "completedAt": "2026-02-08T01:02:07.904091+00:00",
      "updatedAt": "2026-02-08T01:02:07.903974+00:00"
    },
    {
      "id": "US-011",
      "title": "Integrate reminder scheduler with resume command",
      "status": "done",
      "dependsOn": [
        "US-008",
        "US-010"
      ],
      "description": "As a user, I want reminders checked and sent when I run resume or status, so that I receive scheduled notifications.",
      "acceptanceCriteria": [
        "Update src/cli/commands/resume.ts to check reminders on startup",
        "Update src/cli/commands/status.ts to check reminders on execution",
        "Load reminder state from .criticality/notification-state.json",
        "Call ReminderScheduler.checkAndSendReminder if blocked",
        "Display next scheduled reminder in status output if blocked",
        "Save updated reminder state after check",
        "Example: Running 'crit status' at 9:05am triggers 9am reminder if not sent",
        "Negative case: Reminder already sent today, not sent again"
      ],
      "startedAt": "2026-02-08T01:02:09.973027+00:00",
      "completedAt": "2026-02-08T01:11:47.310125+00:00",
      "updatedAt": "2026-02-08T01:11:47.309941+00:00"
    },
    {
      "id": "US-012",
      "title": "Remove deprecated hook system",
      "status": "done",
      "dependsOn": [
        "US-010",
        "US-011"
      ],
      "description": "As a developer, I want the old hook system removed so that there's a single unified notification approach.",
      "acceptanceCriteria": [
        "Delete src/cli/hooks.ts",
        "Delete src/cli/hooks.test.ts if it exists",
        "Remove NotificationHooks and NotificationHook types from src/config/types.ts",
        "Remove hooks parsing from src/config/parser.ts",
        "Remove hooks from src/config/defaults.ts",
        "Update any imports that referenced hooks module",
        "Ensure all tests still pass after removal",
        "Example: No references to 'hooks' remain in notification-related code",
        "Negative case: Do not remove unrelated hook concepts (e.g., git hooks)"
      ],
      "startedAt": "2026-02-08T01:11:49.383903+00:00",
      "completedAt": "2026-02-08T01:29:45.696641+00:00",
      "updatedAt": "2026-02-08T01:29:45.696516+00:00"
    },
    {
      "id": "US-013",
      "title": "Add notification status to CLI status command",
      "status": "done",
      "dependsOn": [
        "US-011"
      ],
      "description": "As a user, I want to see notification configuration and reminder status in the status command output, so that I know notifications are working.",
      "acceptanceCriteria": [
        "Update src/cli/commands/status.ts to display notification section",
        "Show configured channels with enabled/disabled status",
        "Show reminder schedule (cron expression) if configured",
        "Show next scheduled reminder time if blocked",
        "Show last notification sent time if available",
        "Format: 'Notifications: 2 webhooks configured | Next reminder: 9:00 AM'",
        "Example: Status shows 'Notifications: webhook (enabled) | Reminders: 0 9 * * * (next: tomorrow 9:00 AM)'",
        "Negative case: No notifications configured shows 'Notifications: disabled'"
      ],
      "startedAt": "2026-02-08T01:29:47.770255+00:00",
      "completedAt": "2026-02-08T01:38:42.210128+00:00",
      "updatedAt": "2026-02-08T01:38:42.210000+00:00"
    },
    {
      "id": "US-014",
      "title": "Add webhook endpoint validation",
      "status": "done",
      "dependsOn": [
        "US-005",
        "US-006"
      ],
      "description": "As a user, I want webhook endpoints validated at startup so that I know if my configuration is correct.",
      "acceptanceCriteria": [
        "Add validateWebhookEndpoint function to src/notifications/webhook.ts",
        "Validate URL format (must be valid http/https URL)",
        "Optionally send test ping on startup if configured (disabled by default)",
        "Display validation results in startup output",
        "Continue with warnings if validation fails (don't block startup)",
        "Example: 'Webhook https://example.com/hook validated successfully'",
        "Negative case: Invalid URL 'not-a-url' shows warning but doesn't crash"
      ],
      "startedAt": "2026-02-08T01:38:44.284280+00:00",
      "completedAt": "2026-02-08T01:49:18.281587+00:00",
      "updatedAt": "2026-02-08T01:49:18.281470+00:00"
    },
    {
      "id": "US-015",
      "title": "Add integration tests for notification system",
      "status": "done",
      "dependsOn": [
        "US-009",
        "US-010",
        "US-011",
        "US-012"
      ],
      "description": "As a developer, I want integration tests for the notification system so that I can verify end-to-end behavior.",
      "acceptanceCriteria": [
        "Create src/notifications/integration.test.ts",
        "Test NotificationService with mocked webhook endpoints",
        "Test ReminderScheduler state persistence and loading",
        "Test orchestrator integration triggers correct notifications",
        "Test CLI commands check reminders correctly",
        "Test multiple channels receive notifications",
        "Example: Test verifies blocking state triggers webhook POST with correct payload",
        "Negative case: Test verifies failed webhook doesn't affect protocol execution"
      ],
      "startedAt": "2026-02-08T01:49:20.355029+00:00",
      "completedAt": "2026-02-08T02:14:43.135494+00:00",
      "updatedAt": "2026-02-08T02:14:43.135340+00:00"
    },
    {
      "id": "US-016",
      "title": "Update SPECIFICATION.md with notification system documentation",
      "status": "done",
      "dependsOn": [
        "US-012",
        "US-013"
      ],
      "description": "As a developer, I want the specification updated to document the new notification system, so that the documentation matches implementation.",
      "acceptanceCriteria": [
        "Update Section 5.5 (Human Intervention & Blocking) with notification details",
        "Document webhook payload structure",
        "Document cron-based reminder schedule configuration",
        "Update Appendix C (Configuration Reference) with notification config example",
        "Remove or update references to old hook system",
        "Example: Spec shows '[notifications]' TOML config with channels array",
        "Negative case: Do not remove existing valid documentation about blocking behavior"
      ],
      "startedAt": "2026-02-08T02:14:45.205896+00:00",
      "completedAt": "2026-02-08T02:19:58.290508+00:00",
      "updatedAt": "2026-02-08T02:19:58.290347+00:00"
    }
  ]
}
