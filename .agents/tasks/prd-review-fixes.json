{
  "version": 1,
  "project": "Code Review Fixes Phase 2",
  "overview": "Address all code quality issues identified in review.md including code deduplication, type safety improvements, test reliability fixes, and documentation additions.",
  "goals": [
    "Extract shared utilities to reduce code duplication",
    "Fix TypeScript type safety issues",
    "Improve test reliability and remove duplicates",
    "Add proper documentation to public APIs",
    "Clean up dead code and fix export issues"
  ],
  "nonGoals": [
    "Adding new features beyond the review items",
    "Refactoring code not mentioned in the review",
    "Changing public API signatures"
  ],
  "successMetrics": [
    "All quality gates pass",
    "No duplicate code for escapeString",
    "No duplicate tests in verdict-handler.test.ts",
    "All exports correctly typed (values vs types)"
  ],
  "openQuestions": [],
  "stack": {
    "framework": "TypeScript/Node.js",
    "hosting": "N/A",
    "database": "N/A",
    "auth": "N/A"
  },
  "routes": [],
  "uiNotes": [],
  "dataModel": [],
  "importFormat": {
    "description": "N/A",
    "example": {}
  },
  "rules": [
    "Preserve existing behavior - these are refactoring fixes only",
    "All tests must continue to pass after changes"
  ],
  "qualityGates": [
    "npm run lint",
    "npm run typecheck",
    "npm test"
  ],
  "stories": [
    {
      "id": "US-001",
      "title": "Extract escapeString utility to shared module",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want escapeString to be in a shared utility module so that code is not duplicated between negative-test-generator.ts and temporal-test-generator.ts.",
      "acceptanceCriteria": [
        "Create new utility file (e.g., src/utils/string-utils.ts or src/adapters/typescript/utils.ts) with exported escapeString function",
        "Move the escapeString implementation from negative-test-generator.ts to the new utility",
        "Update negative-test-generator.ts to import escapeString from the utility",
        "Update temporal-test-generator.ts to import escapeString from the utility",
        "Remove local escapeString definitions from both files",
        "Example: import { escapeString } from './utils.js' in both generator files",
        "Negative case: attempting to use a non-existent local escapeString should cause a compile error",
        "All existing tests pass unchanged"
      ],
      "startedAt": "2026-02-06T10:04:52.392328+00:00",
      "completedAt": "2026-02-06T10:08:13.441415+00:00",
      "updatedAt": "2026-02-06T10:08:13.441224+00:00"
    },
    {
      "id": "US-002",
      "title": "Standardize test closing style in negative-test-generator.ts",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want consistent closing style for it() calls so that generated test code is uniform.",
      "acceptanceCriteria": [
        "Around lines 373-377 in negative-test-generator.ts, update the main test generation block",
        "Replace the three-line closing pattern ('    },', timeout object, '  );') with single-line style",
        "New format should be: '  }, { timeout: ${String(timeout)} });'",
        "Match the style used in per-function tests",
        "Example: generated test should end with '}, { timeout: 30000 });' on one line",
        "Negative case: multi-line closing should not appear in generated output",
        "All existing tests pass unchanged"
      ],
      "startedAt": "2026-02-06T10:08:15.536595+00:00",
      "completedAt": "2026-02-06T10:10:57.725019+00:00",
      "updatedAt": "2026-02-06T10:10:57.724883+00:00"
    },
    {
      "id": "US-003",
      "title": "Add property-based tests to temporal-test-generator.test.ts",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want property-based tests using fast-check so that edge cases in string escaping and claim filtering are caught.",
      "acceptanceCriteria": [
        "Install fast-check if not already present: npm install --save-dev fast-check",
        "Import fast-check in temporal-test-generator.test.ts",
        "Add fc.assert(fc.property(...)) tests for generateTemporalTest",
        "Generate arbitrary claim objects with varying id, description (including special chars), type, and functions arrays",
        "Assert generated output includes claim.id, safely-escaped description, 'Temporal:' header, and timeout block",
        "Add property test for generateTemporalTests to verify only claims with type === 'temporal' are included",
        "Assert that claim ids are preserved in output",
        "Example: claim with description containing quotes and backslashes should be properly escaped",
        "Negative case: claim with type !== 'temporal' should not appear in generateTemporalTests output"
      ],
      "startedAt": "2026-02-06T10:10:59.819840+00:00",
      "completedAt": "2026-02-06T10:17:15.427821+00:00",
      "updatedAt": "2026-02-06T10:17:15.427698+00:00"
    },
    {
      "id": "US-004",
      "title": "Fix or remove escalation.test.ts.bak file",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the backup test file either fixed and renamed or removed so that CI only sees valid test files.",
      "acceptanceCriteria": [
        "Decide: either rename to escalation.test.ts (if tests are needed) or delete the file",
        "If keeping: fix Map access - use attempts.attemptsByTier.get('worker') instead of dot notation",
        "If keeping: fix lines 122-129 to reference 'updated' variable instead of 'attempts'",
        "If keeping: use attemptsByTier.get('fallback') ?? 0 for fallback access",
        "If deleting: add .bak pattern to .gitignore if backup files should remain locally",
        "Example: attemptsByTier.get('worker') returns the correct Map value",
        "Negative case: dot notation on Map should not be used",
        "CI/test runner only sees valid .test.ts/.spec.ts files"
      ],
      "startedAt": "2026-02-06T10:17:17.518004+00:00",
      "completedAt": "2026-02-06T10:21:02.961749+00:00",
      "updatedAt": "2026-02-06T10:21:02.961550+00:00"
    },
    {
      "id": "US-005",
      "title": "Fix type narrowing in cluster-definer.ts regex extraction",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want allTypeNames to be strongly typed as string[] so that TypeScript noUncheckedIndexedAccess is satisfied.",
      "acceptanceCriteria": [
        "Around lines 68-71 in cluster-definer.ts, update the flatMap callback",
        "Extract match[1] into a variable before returning",
        "Add type guard filter: (v): v is string => v !== undefined",
        "Or use .filter(Boolean) with appropriate type assertion",
        "Apply same fix to params and returnType extraction",
        "Result: allTypeNames is typed as string[] not (string | undefined)[]",
        "Example: flatMap result filtered with type guard compiles without errors",
        "Negative case: undefined values should not be in the final array"
      ],
      "startedAt": "2026-02-06T10:21:05.037507+00:00",
      "completedAt": "2026-02-06T10:25:46.649024+00:00",
      "updatedAt": "2026-02-06T10:25:46.648872+00:00"
    },
    {
      "id": "US-006",
      "title": "Make cluster-executor.test.ts retry test deterministic with fake timers",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the retry test to use fake timers so that it runs fast and deterministically.",
      "acceptanceCriteria": [
        "In 'should retry on retryable infrastructure failures' test (lines 224-260)",
        "Call vi.useFakeTimers() before invoking executeClusters",
        "Replace real delay waits with vi.advanceTimersByTime() or vi.runAllTimers()",
        "Call vi.useRealTimers() after the test",
        "Maintain assertions on runTests call counts and result.success",
        "Test should complete in under 1 second instead of up to 60s",
        "Example: vi.advanceTimersByTime(5000) simulates 5 second backoff",
        "Negative case: test should not use real setTimeout delays"
      ],
      "startedAt": "2026-02-06T10:25:48.742804+00:00",
      "completedAt": "2026-02-06T10:30:15.471585+00:00",
      "updatedAt": "2026-02-06T10:30:15.471342+00:00"
    },
    {
      "id": "US-007",
      "title": "Replace trivial ClusterExecutionSummary test with real runtime test",
      "status": "done",
      "dependsOn": [
        "US-006"
      ],
      "description": "As a developer, I want meaningful runtime tests for ClusterExecutionSummary so that the test provides actual value.",
      "acceptanceCriteria": [
        "Around lines 263-285 in cluster-executor.test.ts",
        "Either delete the trivial structure-only test OR replace with real test",
        "If replacing: call executeClusters with mocked clusters/tasks",
        "Assert returned ClusterExecutionSummary has expected properties: clusters, success, totalClaims, passedClaims, failedClaims, skippedClaims, errorClaims, totalDurationMs",
        "Verify property values match expected state based on mock inputs",
        "Example: executeClusters with 2 passing claims returns passedClaims: 2",
        "Negative case: manually constructed object assertion provides no value"
      ],
      "startedAt": "2026-02-06T10:30:17.567054+00:00",
      "completedAt": "2026-02-06T10:35:16.749623+00:00",
      "updatedAt": "2026-02-06T10:35:16.749387+00:00"
    },
    {
      "id": "US-008",
      "title": "Fix index.ts exports for runtime constants",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want DEFAULT_TIMEOUT and DEFAULT_MAX_RETRIES exported as values so that consumers can access them at runtime.",
      "acceptanceCriteria": [
        "In src/mesoscopic/index.ts around lines 27-38",
        "Remove DEFAULT_TIMEOUT and DEFAULT_MAX_RETRIES from the 'export type' statement",
        "Add separate value export: export { DEFAULT_TIMEOUT, DEFAULT_MAX_RETRIES } from './cluster-executor.js'",
        "Keep type-only exports for ClusterExecutionOptions, ClusterExecutionResult, etc.",
        "Example: import { DEFAULT_TIMEOUT } from './mesoscopic' gives runtime access to the value",
        "Negative case: type-only export removes value at runtime"
      ],
      "startedAt": "2026-02-06T10:35:18.841205+00:00",
      "completedAt": "2026-02-06T10:38:09.317387+00:00",
      "updatedAt": "2026-02-06T10:38:09.317194+00:00"
    },
    {
      "id": "US-009",
      "title": "Fix mockRouter types in spec-driven-test-generator.test.ts",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want mockRouter to use proper ModelRouter types so that the mock matches the real API.",
      "acceptanceCriteria": [
        "Around lines 16-69 in spec-driven-test-generator.test.ts",
        "Update prompt and complete method return type annotations",
        "Use ModelRouter's actual return types or ReturnType<> utility",
        "Update stream generator yield type to appropriate stream response type",
        "Replace literal types (e.g., content: 'generated test code') with proper interface types",
        "Include generic usage and metadata fields as needed",
        "Example: mock return type matches Response interface from ModelRouter",
        "Negative case: literal string types should not be used for content"
      ],
      "startedAt": "2026-02-06T10:38:11.410663+00:00",
      "completedAt": "2026-02-06T10:42:38.874655+00:00",
      "updatedAt": "2026-02-06T10:42:38.874436+00:00"
    },
    {
      "id": "US-010",
      "title": "Remove dead skippedClaims computation in spec-driven-test-generator.ts",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want unused code removed so that the codebase is clean and maintainable.",
      "acceptanceCriteria": [
        "Around lines 209-227 in spec-driven-test-generator.ts",
        "Locate skippedClaims variable and loop in generateTestsForCluster",
        "Either delete the dead computation entirely",
        "Or wire it up: modify generateTestsForCluster to return skippedClaims and update callers",
        "If deleting: remove the skippedClaims declaration and associated loop",
        "Avoid duplicate logic between generateTestsForCluster and generateSpecDrivenTests",
        "Example: after fix, no unused variable warning for skippedClaims",
        "Negative case: dead code should not remain in codebase"
      ],
      "startedAt": "2026-02-06T10:42:40.968501+00:00",
      "completedAt": "2026-02-06T10:47:09.058602+00:00",
      "updatedAt": "2026-02-06T10:47:09.058354+00:00"
    },
    {
      "id": "US-011",
      "title": "Remove baseline performance regression docstring claim",
      "status": "done",
      "dependsOn": [
        "US-010"
      ],
      "description": "As a developer, I want the docstring to match the implementation so that documentation is accurate.",
      "acceptanceCriteria": [
        "Around lines 359-361 in spec-driven-test-generator.ts",
        "Update docstring to remove 'Detects performance regression if baseline is available' claim",
        "The baseline feature is not implemented, so remove the false documentation",
        "Example: docstring accurately reflects current behavior without mentioning baseline",
        "Negative case: docstring should not claim features that don't exist"
      ],
      "startedAt": "2026-02-06T10:47:11.153200+00:00",
      "completedAt": "2026-02-06T10:50:57.446908+00:00",
      "updatedAt": "2026-02-06T10:50:57.446690+00:00"
    },
    {
      "id": "US-012",
      "title": "Move fs import to top of spec-driven-test-generator.ts",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want imports consolidated at the top of files so that code organization is consistent.",
      "acceptanceCriteria": [
        "Around lines 452-457 in spec-driven-test-generator.ts",
        "Move 'import * as fs from 'node:fs/promises'' to top of file with other imports",
        "Remove the duplicate import from its current mid-file location",
        "Ensure readFile function continues to work unchanged",
        "Example: all imports appear in the first 20 lines of the file",
        "Negative case: imports should not appear below function definitions"
      ],
      "startedAt": "2026-02-06T10:50:59.538039+00:00",
      "completedAt": "2026-02-06T10:55:07.703244+00:00",
      "updatedAt": "2026-02-06T10:55:07.703055+00:00"
    },
    {
      "id": "US-013",
      "title": "Remove duplicate tests in verdict-handler.test.ts",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want each behavior tested only once so that tests are maintainable.",
      "acceptanceCriteria": [
        "Remove duplicate 'should identify functions linked to violated claims when CLAIM_REF exists' test (lines ~149-215 or ~352-411)",
        "Remove duplicate 'should return pass verdict when all claims passed' test (lines ~258-302)",
        "Remove duplicate 'should trigger fallback when no CLAIM_REF links exist for violated claim' test (lines ~413-452)",
        "Keep the canonical version of each test that correctly exercises handleClusterVerdict",
        "Verify no references to removed blocks remain",
        "Example: grep for test name returns exactly one match",
        "Negative case: duplicate it() blocks should not exist"
      ],
      "startedAt": "2026-02-06T10:55:09.792964+00:00",
      "completedAt": "2026-02-06T11:00:08.721068+00:00",
      "updatedAt": "2026-02-06T11:00:08.720871+00:00"
    },
    {
      "id": "US-014",
      "title": "Fix inline import type in verdict-handler.ts",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want consistent import style so that code follows conventions.",
      "acceptanceCriteria": [
        "Around lines 341-344 in verdict-handler.ts",
        "Replace inline import type import('../ledger/ledger.js').Ledger with imported Ledger type",
        "Ensure Ledger is imported at the top of the file",
        "Update processClusterVerdict signature to use Ledger directly",
        "Example: function processClusterVerdict(options: VerdictOptions, ledger: Ledger)",
        "Negative case: inline import(...).Type pattern should not be used when type is already imported"
      ],
      "startedAt": "2026-02-06T11:00:10.814754+00:00",
      "completedAt": "2026-02-06T11:04:42.539702+00:00",
      "updatedAt": "2026-02-06T11:04:42.539437+00:00"
    },
    {
      "id": "US-015",
      "title": "Add tsconfig.json error handling in verdict-handler.ts",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want clear error messages when tsconfig.json is missing so that debugging is easier.",
      "acceptanceCriteria": [
        "Around lines 232-234 in verdict-handler.ts",
        "Add error handling for new Project({ tsConfigFilePath: ... }) call",
        "Option A: Check fs.existsSync(path.join(options.projectPath, 'tsconfig.json')) before calling",
        "Option B: Wrap new Project(...) in try-catch",
        "On failure: throw or log clear error referencing options.projectPath and tsConfigFilePath",
        "Example: error message says 'tsconfig.json not found at /path/to/project/tsconfig.json'",
        "Negative case: generic 'file not found' without path context is unhelpful"
      ],
      "startedAt": "2026-02-06T11:04:44.635127+00:00",
      "completedAt": "2026-02-06T11:07:56.326349+00:00",
      "updatedAt": "2026-02-06T11:07:56.326115+00:00"
    },
    {
      "id": "US-016",
      "title": "Add TSDoc comments to logger.ts exports",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want API documentation so that the logger module is self-documenting.",
      "acceptanceCriteria": [
        "Around lines 9-24 in src/utils/logger.ts",
        "Add /** ... */ TSDoc block to LogLevel type",
        "Add TSDoc to LogEntry interface describing timestamp, level, component, event, data fields",
        "Add TSDoc to LoggerOptions interface describing debugMode and other options",
        "Add TSDoc to Logger class with constructor and method documentation",
        "Include @param and @returns annotations for public methods",
        "Example: /** Represents a structured log entry with timestamp and metadata */",
        "Negative case: exported symbols should not lack documentation"
      ],
      "startedAt": "2026-02-06T11:07:58.421822+00:00",
      "completedAt": "2026-02-06T11:12:01.970656+00:00",
      "updatedAt": "2026-02-06T11:12:01.970450+00:00"
    },
    {
      "id": "US-017",
      "title": "Add safe JSON.stringify in logger.ts",
      "status": "done",
      "dependsOn": [
        "US-016"
      ],
      "description": "As a developer, I want logging to not throw on circular refs or BigInt so that the logger is robust.",
      "acceptanceCriteria": [
        "Around lines 52-65 in src/utils/logger.ts, in the log method",
        "Wrap JSON.stringify call in try/catch",
        "On error: build fallback LogEntry with timestamp, level, component, event",
        "Include serializationError: err.message in fallback",
        "Include originalData: '[unserializable]' or omit data field",
        "Write fallback JSON to process.stderr.write",
        "Ensure callers still get single JSON line even when serialization fails",
        "Example: object with circular ref logs error message instead of throwing",
        "Negative case: BigInt in data should not crash the logger"
      ],
      "startedAt": "2026-02-06T11:12:04.060757+00:00",
      "completedAt": "2026-02-06T11:19:00.899355+00:00",
      "updatedAt": "2026-02-06T11:19:00.899157+00:00"
    }
  ]
}
