{
  "version": 1,
  "project": "PR10 Review Fixes",
  "overview": "Address all issues identified in PR10 review, including test fixes, code quality improvements, and markdown formatting across the codebase.",
  "goals": [
    "Fix all test failures and ensure tests match actual generator output",
    "Resolve code quality issues (duplicate code, incorrect assertions, brittle logic)",
    "Fix markdown formatting to satisfy markdownlint rules",
    "Improve error handling and logging consistency",
    "Ensure all quality gates pass (test, lint, typecheck, format:check, build)"
  ],
  "nonGoals": [],
  "successMetrics": [
    "All tests pass (npm run test)",
    "All linting passes (npm run lint)",
    "Type checking passes (npm run typecheck)",
    "Formatting check passes (npm run format:check)",
    "Build succeeds (npm run build)",
    "No markdownlint violations"
  ],
  "openQuestions": [],
  "stack": {
    "framework": "TypeScript/Node.js",
    "hosting": "N/A (tooling library)",
    "database": "N/A",
    "auth": "N/A"
  },
  "routes": [],
  "uiNotes": [],
  "dataModel": [],
  "importFormat": {
    "description": "N/A",
    "example": {}
  },
  "rules": [
    "All changes must pass quality gates before completion",
    "Test expectations must exactly match actual generator output",
    "Fixes should preserve existing functionality unless explicitly changing behavior"
  ],
  "qualityGates": [
    "npm run test",
    "npm run lint",
    "npm run typecheck",
    "npm run format:check",
    "npm run build"
  ],
  "stories": [
    {
      "id": "US-001",
      "title": "Fix markdown formatting in PRD.md",
      "status": "done",
      "dependsOn": [],
      "description": "As a maintainer, I want the PRD.md file to have proper markdown formatting so it satisfies the MD041 rule.",
      "acceptanceCriteria": [
        "Add top-level H1 heading before the existing '## 2026-01-30 10:27' heading",
        "Example: Add '# PRD' or similar project title at line 1",
        "Negative case: Markdown still fails MD041 if no H1 is present before first H2",
        "Document now passes markdownlint MD041 validation"
      ],
      "startedAt": "2026-02-03T15:52:12.704256+00:00",
      "completedAt": "2026-02-03T15:58:36.743872+00:00",
      "updatedAt": "2026-02-03T15:58:36.743750+00:00"
    },
    {
      "id": "US-002",
      "title": "Fix markdown spacing in status and implementation docs",
      "status": "done",
      "dependsOn": [],
      "description": "As a maintainer, I want all markdown documentation files to have consistent spacing and formatting so they satisfy markdownlint rules.",
      "acceptanceCriteria": [
        "Fix US-026-CURRENT-STATUS.md: add blank lines before/after headings, normalize tables, ensure fenced blocks have spacing",
        "Fix US-026-FINAL-STATUS.md: normalize list indentation, fix ordered list numbering, add blank lines before headings",
        "Fix US-026-implementation-summary.md: consistent heading spacing, list markers, and indentation",
        "Fix US-028-FINAL-REPORT.md: add blank lines before/after headings and fenced code blocks",
        "Fix US-028-implementation-summary.md: fix '###CLAIM_REF Linkage' to have space after ###",
        "Example: '## Status' has blank line before and after",
        "Negative case: headings without spacing still fail MD022 validation",
        "All files pass markdownlint validation"
      ],
      "startedAt": "2026-02-03T15:58:38.831085+00:00",
      "completedAt": "2026-02-03T16:13:16.222627+00:00",
      "updatedAt": "2026-02-03T16:13:16.222404+00:00"
    },
    {
      "id": "US-003",
      "title": "Fix TypeScript adapter re-exports and missing value export",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the TypeScript adapter exports to be clean and include all necessary runtime values so consumers can use them correctly.",
      "acceptanceCriteria": [
        "In src/adapters/typescript/index.ts: alias DEFAULT_TIMEOUT from temporal-test-generator.js as TEMPORAL_DEFAULT_TIMEOUT",
        "Alias DEFAULT_TIMEOUT from negative-test-generator.js as NEGATIVE_DEFAULT_TIMEOUT",
        "Remove duplicated generateSpecDrivenTests entry (list only once in mesoscopic exports)",
        "In src/mesoscopic/index.ts: export ClusterDefinitionError as a runtime value, not type-only",
        "Example: export { ClusterDefinitionError } from './types.js;'",
        "Negative case: attempting 'instanceof ClusterDefinitionError' fails without runtime export",
        "All exports are accessible and usable by consumers"
      ],
      "startedAt": "2026-02-03T16:13:18.306431+00:00",
      "completedAt": "2026-02-03T16:18:38.150776+00:00",
      "updatedAt": "2026-02-03T16:18:38.150659+00:00"
    },
    {
      "id": "US-004",
      "title": "Fix invariant test generator duplicate fc.assert closure",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the invariant test generator to correctly generate fc.assert calls without duplication so tests are valid.",
      "acceptanceCriteria": [
        "In src/adapters/typescript/invariant-test-generator.ts: remove duplicate lines when witnesses.length === 0",
        "Remove the lines pushing '{ numRuns: ... }' and closing '));' in generateInvariantTest",
        "Let generateTestProperty remain responsible for closing fc.assert",
        "Apply same fix to the second occurrence (around lines 308-312)",
        "Keep invariant body and comments intact",
        "Example: generated test code has exactly one closing '));' for fc.assert",
        "Negative case: test has duplicate closing braces causing syntax error",
        "Generated tests run without syntax errors"
      ],
      "startedAt": "2026-02-03T16:18:40.240204+00:00",
      "completedAt": "2026-02-03T16:27:20.479380+00:00",
      "updatedAt": "2026-02-03T16:27:20.479266+00:00"
    },
    {
      "id": "US-005",
      "title": "Fix negative test generator regex pattern",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want extractForbiddenOutcome to return the actual outcome token instead of the verb so test generation is correct.",
      "acceptanceCriteria": [
        "In src/adapters/typescript/negative-test-generator.ts: update extractForbiddenOutcome",
        "Change pattern (/never\\s+(produces?|results?\\s+in)\\s+(\\w+)/i) to use non-capturing intermediate group or select correct capture",
        "Return match[2] when present instead of match[1]",
        "Example: 'never produces error' returns 'error' not 'produces'",
        "Negative case: 'never results in failure' returns 'failure' not 'results'",
        "Extracted outcomes are correct nouns, not verbs"
      ],
      "startedAt": "2026-02-03T16:27:22.569850+00:00",
      "completedAt": "2026-02-03T16:32:55.838199+00:00",
      "updatedAt": "2026-02-03T16:32:55.838024+00:00"
    },
    {
      "id": "US-006",
      "title": "Fix negative test generator test expectations",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the test expectations to exactly match the actual generator output so tests pass reliably.",
      "acceptanceCriteria": [
        "In src/adapters/typescript/negative-test-generator.test.ts: update assertions around lines 20-41",
        "Remove extra bracket in it title, use real describe string",
        "Correct expectedFailure/assertion messages to exact phrases (e.g., 'Forbidden outcome: ...')",
        "Apply same corrections to failing block around lines 95-123",
        "All expectations must match generateNegativeTest(claim, { includeJsDoc: false }) output exactly",
        "Example: describe title matches generator's actual describe string",
        "Negative case: tests fail if expectations don't match exact generator output",
        "All negative test generator tests pass"
      ],
      "startedAt": "2026-02-03T16:32:57.921063+00:00",
      "completedAt": "2026-02-03T16:41:27.299226+00:00",
      "updatedAt": "2026-02-03T16:41:27.299007+00:00"
    },
    {
      "id": "US-007",
      "title": "Fix temporal test generator template literal and placeholder variables",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the temporal test generator to correctly interpolate variables and declare placeholders so generated tests run without errors.",
      "acceptanceCriteria": [
        "In src/adapters/typescript/temporal-test-generator.ts line 321: change TODO string to template literal with backticks for ${func} interpolation",
        "Update session test block (lines 137-163): declare distinct placeholder variables (midIsValid, afterIsValid) with initial boolean values",
        "Use placeholder names in console.log/assert lines instead of undefined isValid",
        "Keep commented TODOs for real validation calls",
        "Example: 'const midIsValid = false; const afterIsValid = false;' declared before validation calls",
        "Negative case: generated test throws ReferenceError: isValid is not defined",
        "Generated temporal tests execute without runtime errors"
      ],
      "startedAt": "2026-02-03T16:41:29.367492+00:00",
      "completedAt": "2026-02-03T16:54:51.563315+00:00",
      "updatedAt": "2026-02-03T16:54:51.563200+00:00"
    },
    {
      "id": "US-008",
      "title": "Fix temporal test generator malformed it() closing",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the temporal test generator to emit properly formatted it() blocks so generated tests are syntactically correct.",
      "acceptanceCriteria": [
        "In src/adapters/typescript/temporal-test-generator.ts around lines 304-307: remove standalone closing brace",
        "Replace two-line close with single consolidated close using options-object syntax",
        "Emit one closing line ending with '}, { timeout: <value> })'",
        "Update code building lines array (escapedTestName, generateTestBody, timeout)",
        "Example: final closing is '}, { timeout: 30000 });' not separate '}\\n}, 30000);'",
        "Negative case: generated test has syntax error from malformed it() closing",
        "Generated it() blocks are syntactically valid"
      ],
      "startedAt": "2026-02-03T16:54:53.644540+00:00",
      "completedAt": "2026-02-03T17:03:01.319510+00:00",
      "updatedAt": "2026-02-03T17:03:01.319393+00:00"
    },
    {
      "id": "US-009",
      "title": "Fix temporal test generator test expectations",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the temporal test generator test expectations to match actual output so tests pass.",
      "acceptanceCriteria": [
        "In src/adapters/typescript/temporal-test-generator.test.ts lines 25-50: update all assertions",
        "Match exact quote styles (double quotes where generator emits them)",
        "Match exact phrases: 'Temporal: [temp_001] session is valid for 30 minutes', it signature, final tokens",
        "Align variable/log strings exactly as generator emits",
        "Match console.log messages, validateSession calls, timeout object text",
        "Update duplicated expectation texts to exact emitted lines",
        "Example: describe header uses exact text generator produces",
        "Negative case: assertions fail due to quote style or phrase mismatches",
        "All temporal test generator tests pass"
      ],
      "startedAt": "2026-02-03T17:03:03.397551+00:00",
      "completedAt": "2026-02-03T17:08:16.415997+00:00",
      "updatedAt": "2026-02-03T17:08:16.415871+00:00"
    },
    {
      "id": "US-010",
      "title": "Fix cluster definer test assertions and forEach callbacks",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want cluster definer tests to be robust and code to satisfy linting rules so tests are reliable and maintainable.",
      "acceptanceCriteria": [
        "In src/mesoscopic/cluster-definer.test.ts lines 38-42: replace index-based assertions with find-based lookups",
        "Locate modules by name/id using Array.prototype.find",
        "Apply to both occurrences asserting Account/Transaction",
        "In src/mesoscopic/cluster-definer.ts lines 262-277: change forEach callbacks to block bodies with explicit statements",
        "Update allClaims.forEach, allModules.forEach, unassignedModuleClaims.forEach",
        "Example: forEach((c) => { assignedClaims.add(c); })",
        "Negative case: tests are flaky due to order-sensitive index assertions",
        "Code satisfies Biome lint rule no implicit returns",
        "Tests pass consistently regardless of module order"
      ],
      "startedAt": "2026-02-03T17:08:18.474517+00:00",
      "completedAt": "2026-02-03T17:39:22.281845+00:00",
      "updatedAt": "2026-02-03T17:39:22.281692+00:00"
    },
    {
      "id": "US-011",
      "title": "Fix cluster definer validateClusterResult logic",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want validateClusterResult to properly detect invalid module IDs so validation actually works.",
      "acceptanceCriteria": [
        "In src/mesoscopic/cluster-definer.ts lines 406-424: build validModuleIds Set from result.modules",
        "Replace faulty allModules usage with check against validModuleIds",
        "Validate cluster.module IDs against canonical module list in result.modules",
        "Remove or update allModules reference/declaration",
        "Example: validModuleIds = new Set(result.modules.map(m => m.id))",
        "Negative case: invalid module ID in cluster passes validation incorrectly",
        "Invalid module IDs in clusters are properly rejected"
      ],
      "startedAt": "2026-02-03T17:39:24.359498+00:00",
      "completedAt": "2026-02-03T17:43:00.524797+00:00",
      "updatedAt": "2026-02-03T17:43:00.524684+00:00"
    },
    {
      "id": "US-012",
      "title": "Fix cluster executor test mock consistency",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the cluster executor test mock data to be consistent so test assertions are accurate.",
      "acceptanceCriteria": [
        "In src/mesoscopic/cluster-executor.test.ts lines 32-74: update mockRunTests response",
        "Make totalTests match tests array length",
        "Either add missing third test entry with appropriate data or adjust totalTests to 2",
        "Update passed/failed counts to match test data",
        "Ensure executeClusters expectations (totalClaims, passedClaims, failedClaims) align with fixture",
        "Example: if tests array has 2 entries, set totalTests: 2",
        "Negative case: test passes but assertions are misleading due to mismatched totals",
        "Mock data is internally consistent"
      ],
      "startedAt": "2026-02-03T17:43:02.612108+00:00",
      "completedAt": "2026-02-03T17:53:32.601422+00:00",
      "updatedAt": "2026-02-03T17:53:32.601293+00:00"
    },
    {
      "id": "US-013",
      "title": "Fix cluster executor error detection and structured logging",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want cluster executor to use structured error detection and logging for better observability and maintainability.",
      "acceptanceCriteria": [
        "In src/mesoscopic/cluster-executor.ts lines 194-220: update hasNotFoundError logic",
        "Prefer structured error properties (error.code === 'ENOENT', error.name, instanceof)",
        "Use case-insensitive message match only as fallback",
        "Lines 317-400: replace console.log/console.error with structured logger",
        "Import logger from '../utils/logger.js'",
        "Use logger.info/warn/error with structured metadata (clusterId, status, etc.)",
        "Remove eslint-disable-next-line no-console comments",
        "Example: logger.info({ clusterId: cluster.id, success: result.success })",
        "Negative case: console logging lacks structured metadata for analysis",
        "All logging uses structured logger with appropriate metadata"
      ],
      "startedAt": "2026-02-03T17:53:34.691682+00:00",
      "completedAt": "2026-02-04T12:43:28.688113+00:00",
      "updatedAt": "2026-02-04T12:43:28.687873+00:00"
    },
    {
      "id": "US-014",
      "title": "Fix cluster executor claim ID matching and retry strategy",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want claim ID matching to be precise and retries to use exponential backoff for reliability.",
      "acceptanceCriteria": [
        "In src/mesoscopic/cluster-executor.ts lines 109-113: update claimIds loop filter",
        "Replace includes with word-boundary regex match",
        "Escape claimId before building RegExp to avoid injection",
        "Lines 371-383: replace five flatMap+filter passes with single reduce",
        "Accumulate totalClaims, passedClaims, failedClaims, skippedClaims, errorClaims in one pass",
        "Line 268: replace linear delay with exponential backoff + jitter",
        "Use Math.min(maxDelayMs, baseDelayMs * 2 ** attempt) with random jitter",
        "Example: regex = new RegExp(`\\\\b${escapeRegExp(claimId)}\\\\b`, 'i')",
        "Negative case: 'inv-1' incorrectly matches 'inv-10' with includes",
        "Claim matching is precise and no false positives occur",
        "Retry uses proper exponential backoff with jitter"
      ],
      "startedAt": "2026-02-04T12:43:30.769126+00:00",
      "completedAt": "2026-02-04T12:55:27.849357+00:00",
      "updatedAt": "2026-02-04T12:55:27.849165+00:00"
    },
    {
      "id": "US-015",
      "title": "Fix spec-driven test generator baseline and linkage",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the spec-driven test generator to use baseline data and correctly link claims to functions.",
      "acceptanceCriteria": [
        "In src/mesoscopic/spec-driven-test-generator.ts lines 428-500: wire baseline into performance evaluation",
        "Pass baseline to generateTestsForCluster or new evaluateRegressions function",
        "Update options.baselinePath and loadBaseline to work with new flow",
        "Lines 121-135: fix inverted linkage in linkClaimsToFunctions",
        "Build inverse map from claimId \u2192 functionId[] first",
        "Iterate claims and set claim.functions to collected array",
        "Example: inverseMap[claimId].push(functionId) for each functionId's claimIds",
        "Negative case: TestableClaim.functions is empty when it should have function references",
        "Baseline is actually used for performance regression detection",
        "TestableClaim.functions is correctly populated"
      ],
      "startedAt": "2026-02-04T12:55:29.936054+00:00",
      "completedAt": "2026-02-04T17:07:32.021356+00:00",
      "updatedAt": "2026-02-04T17:07:32.021196+00:00"
    },
    {
      "id": "US-016",
      "title": "Fix spec-driven test generator test lifecycle cleanup",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want test lifecycle cleanup to prevent state leaks between tests.",
      "acceptanceCriteria": [
        "In src/mesoscopic/spec-driven-test-generator.test.ts lines 8-15: add beforeEach to save console.warn and temp paths",
        "Add afterEach to restore console.warn",
        "Add afterEach to delete temp dirs via fs.rm(path, { recursive: true, force: true })",
        "Apply to sections exercising generateSpecDrivenTests/SpecDrivenTestOptions",
        "Ensure afterEach runs regardless of test failures",
        "Example: afterEach(() => { console.warn = _origWarn; fs.rmSync(tempPath, { recursive: true, force: true }); })",
        "Negative case: temp directories accumulate across test runs",
        "No filesystem artifacts or console.warn replacements leak between tests"
      ],
      "startedAt": "2026-02-04T17:07:34.097378+00:00",
      "completedAt": "2026-02-04T17:14:12.233106+00:00",
      "updatedAt": "2026-02-04T17:14:12.232963+00:00"
    },
    {
      "id": "US-017",
      "title": "Fix verdict handler recorded claims and function claim mapping",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the verdict handler to only record violated claims and maintain accurate function-to-file mappings.",
      "acceptanceCriteria": [
        "In src/mesoscopic/verdict-handler.ts lines 269-270: change recordedClaims to always equal violatedClaims",
        "Remove fallbackTriggered branch that assigned all cluster.claimIds",
        "Lines 90-173: update buildFunctionClaimMapping to store filePath",
        "Change mapping to store objects like { filePath, claimRefs } or use composite key",
        "Update identifyFunctionsToReinject to use stored filePath instead of getFunctionFilePath",
        "Remove brittle getFunctionFilePath behavior",
        "Example: mapping.set(functionName, { filePath: sourceFile, claimRefs: [...] })",
        "Negative case: fallback triggers and marks passed claims as violations",
        "Only violated claims are recorded, function paths are accurate"
      ],
      "startedAt": "2026-02-04T17:14:14.325437+00:00",
      "completedAt": "2026-02-04T17:39:39.251863+00:00",
      "updatedAt": "2026-02-04T17:39:39.251680+00:00"
    },
    {
      "id": "US-018",
      "title": "Fix verdict handler test syntax error",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the verdict handler test file to be syntactically valid so tests can run.",
      "acceptanceCriteria": [
        "In src/mesoscopic/verdict-handler.test.ts lines 358-364: remove stray '});'",
        "Ensure previous test block is properly closed once",
        "New describe('recordViolatedClaimsInLedger'...) starts cleanly",
        "Locate stray closing tokens near expect stringContaining('No CLAIM_REF links found')",
        "Example: file has balanced braces for all describe/it blocks",
        "Negative case: test file has syntax error preventing execution",
        "Test file is syntactically valid and tests run"
      ],
      "startedAt": "2026-02-04T17:39:41.321827+00:00",
      "completedAt": "2026-02-04T17:45:34.326378+00:00",
      "updatedAt": "2026-02-04T17:45:34.326217+00:00"
    }
  ]
}
